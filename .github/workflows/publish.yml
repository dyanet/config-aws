name: Publish Packages

on:
  push:
    tags:
      - 'v*'

permissions:
  id-token: write   # Required for npm OIDC provenance
  contents: read

jobs:
  determine-packages:
    runs-on: ubuntu-latest
    outputs:
      config-aws: ${{ steps.check.outputs.config-aws }}
      nestjs-config-aws: ${{ steps.check.outputs.nestjs-config-aws }}
      nextjs-config-aws: ${{ steps.check.outputs.nextjs-config-aws }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: Check which packages need publishing
        id: check
        run: |
          # Compare semver versions: returns true if v1 > v2
          version_gt() {
            test "$(printf '%s\n' "$1" "$2" | sort -V | head -n1)" != "$1"
          }
          
          check_package() {
            local dir=$1
            local name=$2
            local output_key=$3
            
            local_version=$(node -p "require('./${dir}/package.json').version")
            
            # Get published version from npm (returns empty if not published)
            published_version=$(npm view "${name}" version 2>/dev/null || echo "")
            
            echo "Package: ${name}"
            echo "  Local version: ${local_version}"
            echo "  Published version: ${published_version:-none}"
            
            if [ -z "$published_version" ]; then
              echo "  -> Not yet published, needs publishing"
              echo "${output_key}=true" >> $GITHUB_OUTPUT
            elif version_gt "$local_version" "$published_version"; then
              echo "  -> Local version is higher, needs publishing"
              echo "${output_key}=true" >> $GITHUB_OUTPUT
            else
              echo "  -> Published version is same or higher, skipping"
              echo "${output_key}=false" >> $GITHUB_OUTPUT
            fi
          }
          
          check_package "packages/config-aws" "@dyanet/config-aws" "config-aws"
          check_package "packages/nestjs-config-aws" "@dyanet/nestjs-config-aws" "nestjs-config-aws"
          check_package "packages/nextjs-config-aws" "@dyanet/nextjs-config-aws" "nextjs-config-aws"

  publish-config-aws:
    needs: determine-packages
    if: needs.determine-packages.outputs.config-aws == 'true'
    runs-on: ubuntu-latest
    environment: prod
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: Install dependencies (from root)
        run: npm ci

      - name: Build package
        run: npm run build --workspace=@dyanet/config-aws

      - name: Test package
        run: npm run test --workspace=@dyanet/config-aws

      - name: Publish with provenance (OIDC)
        working-directory: packages/config-aws
        run: npm publish --provenance --access public

  publish-nestjs-config-aws:
    needs: [determine-packages, publish-config-aws]
    if: |
      always() &&
      needs.determine-packages.outputs.nestjs-config-aws == 'true' &&
      (needs.publish-config-aws.result == 'success' || needs.publish-config-aws.result == 'skipped')
    runs-on: ubuntu-latest
    environment: prod
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: Install dependencies (from root)
        run: npm ci

      - name: Build package
        run: npm run build --workspace=@dyanet/nestjs-config-aws

      - name: Test package
        run: npm run test --workspace=@dyanet/nestjs-config-aws

      - name: Publish with provenance (OIDC)
        working-directory: packages/nestjs-config-aws
        run: npm publish --provenance --access public

  publish-nextjs-config-aws:
    needs: [determine-packages, publish-config-aws]
    if: |
      always() &&
      needs.determine-packages.outputs.nextjs-config-aws == 'true' &&
      (needs.publish-config-aws.result == 'success' || needs.publish-config-aws.result == 'skipped')
    runs-on: ubuntu-latest
    environment: prod
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: Install dependencies (from root)
        run: npm ci

      - name: Build package
        run: npm run build --workspace=@dyanet/nextjs-config-aws

      - name: Test package
        run: npm run test --workspace=@dyanet/nextjs-config-aws

      - name: Publish with provenance (OIDC)
        working-directory: packages/nextjs-config-aws
        run: npm publish --provenance --access public
